# 성능 테스트 패턴 및 안티 패턴
## 성능 테스트 유형
- 성능 테스트의 본질을 이해하고 실행하자
  - "그래도 뭐라도 안하는거보다 낫지 않나?" 라는 믿음은 버리는게 좋다.
  - 이유는 믿음 때문에 구체적인 내용을 정하지 않고 뭉뚱그려 성능테스트를 하게 된다.
  - 그렇게 실행된 테스트는 정확하지 않고 또 그걸로 인해 이상한 의사결정을 할 가능성도
    존재한다.
  - 반대로 좋은 테스트는 정략적이다. (수치화가 가능한 답변을 내놓을 수 있다.)
    > 성능 테스트를 기획하는 요령 <BR>
    > 1. 테스트를 통해서 확인하고 자 하는 정량적 질문리스트를 작성한다 <BR>
    > 2. 그 테스트가 대상 애플리케이션에서 중요한 이유를 간단히 적어보자
    >    (관리자,팀원,고객들에게 확인들 받아도 좋음)
  - 성능 테스트 종류
    - 지연 테스트(Latency test)
      - 종단 트랜잭선에 걸리는 시간은 ?
    - 처리율 테스트(Throughput test)
      - 현재 시스템이 처리 가능한 동시 트랜잭션의 개수는 ?
    - 부하 테스트(Load test)
      - 특정 부하를 시스템이 감당할 수 있는가?
    - 스트레스 테스트(Stress test)
      - 시스템의 한계점은 어디까지인가?
    - 내구성 테스트(Endurance test)
      - 시스템을 장시간 실행할 경우 성능 이상 증상이 나타나는가?
    - 용량 계획 테스트(Capacity planning test)
      - 리소스를 추가한 만큼 시스템의 성능 향상이 일어나는가?(확장되는가?)
    - 저하 테스트(Degradation test)
      - 시스템이 부분적으로 실패할 경우 어떤 일이 벌어지나?

### 지연 테스트
- 가장 일반적인 성능 테스트다.
- 이 테스트는 말그대로 얼마나 페이지의 로딩이 빠른지?(종단간 트랜잭션)을 측정한다.
- 즉 여기서 측정한 수치는 고객,경영진들이 가장 피부로 많이 느끼는 관심사다.
- 주의할 점으로는 이 테스트는 앞서 말한 테스트를 통해서 무엇을 확인하고자 하는 바가 너무
  명확하고 정량적이기 때문에 다른 종류의 성능테스트로 밝히려는 정량적 질문을 식별해야할 필요성
  마저 흐릿하게 만들수있다.
- 쉽게 말해 지연테스트만 진행하고 다른 성능테스트를 굳이? 라는 생각이 들게 한다는 뜻이다.
### 처리율 테스트(최대 처리율만 측정하는 것을 목표로하면된다.)
- 지연테스트 다음으로 일반적인 성능 테스트
- 어떤 측면에서는 처리율은 지연과 동등한 개념이라고 볼 수 있다.
- 처리율 테스트는 그래프에서 지연을 모니터링 하다가 한계점(변곡점)이 나타날때의 바로 최대
  처리율(시스템 성능이 급락하기 직전) 캐치 하는 것을 목표로 하는 것이다.
- 반면 스트레스 테스트의 목표는 이런 현상(변곡점)이 발생하는 지점과 그 지점의 부하 수준을
  포착하는 것 이다.
### 부하 테스트
- 부하 테스트는 시스템이 이 정도의 부하는 견딜 수 있을까?, 없을까? 에 대한 예/아니오의 답을
  구하는 과정으로 처리율 테스트(스트레스 테스트) 와는 좀 다르다
- ex) 새로운 서비스를 오픈할 때 상당한 트래픽이 몰릴것으로 예상되는 경우를 대비해서 시행한다.
### 스트레스 테스트(최대 처리율 뿐만아니라 그때 발생하는 부하의 수준까지 포착)
- 시스템의 여력이 어느 정도인지 알아보는 수단이다.
- 특정트래픽을(현재의 최대치) 지속적으로 계속준다.
- 시간이 길어질 수록 서서히 동시 트랜잭션이 증가하고 시스템 성능이 저하된다 이때 측정값이
  나빠지기 직전의 값이 바로 최대 처리율이다.
### 내구성 테스트
- 메모리 누수, 캐시오염, 메모리 단편화등 의 문제로 서서히 성능이 저하되는지를 확인하는 테스트
- 그래서 보통 며칠 단위로 시간이 지나고서야 드러나는 문제점이 있다.
- 이런것들을 내구성 테스트를 통해서 감지한다.
- 리소스가 평균 ~ 조금 높은 사용률로 시스템 부하를 일정해서 주면 갑자기 리소스가 고갈되거나
  시스템이 깨지는 지점이 있는데 그걸 찾습니다.
### 용량 계획 테스트
- 업그레이드 한 시스템이 어느 정도의 부하를 버틸 수 있을지 미리 내다보는 테스트다.
### 저하 테스트
- 시스템이 부분적으로 실패할 경우 어떤 일이 벌어지는지를 확인하는 테스트다.
- ex) DB가 죽었을 때, 캐시가 죽었을 때, 네트워크가 끊겼을 때 등등
- 실제로 운영 환경에 떠 있는 라이브 프로세스를 하나씩 랜덤하게 죽이면서 검증?

## 기본 베스트 프랙티스
- 항상 성능테스트,튜닝시 주안점을 두어야 할 부분을 까먹지말자
  - 관심사가 무엇인지 확실하게 식별
  - 측정방법 고민
  - 최적화 하기 용이한 부분이 아니라 중요한 부분을 최적화
  - 중요한 관심사 먼저 다루기
### 하향식 성능
- 자바 애플리케이션을 대규모로 벤치 마킹(테스트) 하는것이 작은코드의 섹션 별의 성능 수치를
  얻는것보다 쉽다.
### 테스트 환경 구축
- 테스트 환경구축은 운영 환경과 똑같이 복제하는 것이 가장 좋고 그것이 기본이다.
- 테스트 환경 구축할 때 비용이 많이 들겠지만 그렇다고 테스트 환경을 만들지 않는다면 이것은
  허위 절약이며 실제로 테스트를 하지 않고 상용에서 장애가 날 경우 더 큰 리스트를 얻을 수
  있다.
### 성능 요건 식별
- 성능은 코드 뿐만아니라 os 하드웨어 컨테이너 등등 전반적인 시스템이 영향을 끼침
- 성능 비기능 요건 : 최적화하려는 핵심 지표
    > 명확한 목표 예시 <BR>
    >  - 95% 백분위 트랜잭션 시간을 100ms로 줄인다. <BR>
    >    - 이 목표는 명확하다. 왜냐하면 성능 개선의 정확한 기준(95% 백분위 트랜잭션 시간)와 목표치(100ms)를 제공하고 있기 때문이다. 이는 구체적인 측정 가능한 수치를 제공하므로, 프로젝트 팀은 이를 이용해 실제 성능 개선을 추적하고 평가할 수 있다. <BR>
    >  - 기존 하드웨어 처리율을 5배 높일 수 있게 시스템 개선 <BR>
    >    - 이 목표 역시 명확하다. 하드웨어 처리율을 5배 높이는 것이 목표이므로, 이를 이루기 위한 조치들을 계획하고 수행할 수 있다. 개선 전후의 처리율을 측정하여 목표 달성 여부를 검증할 수 있다. <BR>
    >  - 평균 응답시간 30% 개선 <BR>
    >    - 이 목표도 명확하다. 평균 응답시간을 30% 개선하는 것이 목표이므로, 이를 위한 개선 방안을 수립하고 측정하여 평가할 수 있다.


    > 모호한 목표예시 <BR>
    >  - 일반 고객을 서비스 하는 리소스 비용을 50% 줄인다. <BR>
    >    - 이 목표는 "일반 고객"이라는 용어와 "리소스 비용"이라는 개념이 모호하기 때문에 모호하다. "일반 고객"은 누구인지, "리소스 비용"은 어떤 리소스에 대한 비용인지 명확히 정의되어 있지 않다. 이러한 모호성으로 인해 이 목표를 측정하거나 달성하는 데 어려움이 있을 수 있다.
    >  - 애플리케이션 클러스터 성능이 50% 떨어져도 시스템이 응답 목표를 25% 이내로 유지한다. <BR>
    >    - 이 목표는 "응답 목표"와 "클러스터 성능"이 무엇인지 명확하게 정의하지 않았으므로 모호 또한, "응답 목표를 2함% 이내로 유지한다"는 문장도 분명하지 않다. 이것이 어떤 상황에서 25% 이내로 유지해야 하는지, 그리고 이것이 어떻게 측정되는지에 대한 정보가 필요하다
    >  -  고객 이탈률을 25ms 지연당 25% 낮춘다.
    >     - 이 목표는 "고객 이탈률"과 "지연"간의 정확한 관계가 명확하지 않기 때문에 모호하다. 지연 시간이 고객 이탈률에 어떤 영향을 미치는지, 그리고 이 관계가 선형적인지 아니면 다른 형태를 가지는지 명확히 모른다. 따라서, 이 목표를 정확히 측정하고 달성하는 것은 어려울 수 있다.

### 자바에 특정한 이슈
- JIT 컴파일러를 잘살펴보자
- JIT 컴파일러가 컴파일을 하지않는 메서드는 둘중하나다
  - JIT 컴파일 할 정도로 자주 실행되는 메서드가 아님
  - 메서드가 너무 크고 복잡해서 도저히 컴파일 분석을 할 수 없는 경우
- 성능 활동을 시작하려면 먼저 어떤 메서드가 컴파을 중인지 로그를 남기고 핵심 코드 경로상의 중요 메서드가 잘 컴파일 되고있는지 확인
### SDLC 일부로 성능 테스트 수행하기
- 수준 높은 팀일수록 성능 테스트를 전체 SDLC의 일부로 수행함 특히 성능 회귀 테스트를 상시 수행함
## 성능 안티패턴 개요
- 성능 튜닝은 항상 초기 기획 단계 부터 구체적으로 목표를 정해놓고 시작하는 목표 지향형 프로세스로 접근해야함
- 의외로 기술적인 측면보다 의사소통 문제 같은 인적 요소가 원인이 될 때가 많다.
- 캐리 플리첼의 '왜 개발자는 잘못된 기술 선택을 밥 먹듯이 하나' 라는 제목의 5가지 원인을 통해서 개발자가 성능 안티패턴에 빠지는 이유를 알아보자
### 지루함
### 이력서 부풀리기
### 또래 압박
### 이해 부족
### 오해와 있지도 않은 문제
